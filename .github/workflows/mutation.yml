name: Mutation Testing

permissions:
  contents: write

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  mutation-test:
    env:
      NORDVPN_SERVER_LIST_URL: ${{ secrets.NORDVPN_SERVER_LIST_URL }}
      NORDVPN_CREDENTIALS_URL: ${{ secrets.NORDVPN_CREDENTIALS_URL }}
      NORDVPN_TOKEN: ${{ secrets.NORDVPN_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install Gremlins
        run: go install github.com/go-gremlins/gremlins/cmd/gremlins@latest

      - name: Run mutation tests
        run: gremlins unleash --config=".gremlins.yml" || true

      - name: Update README with mutation stats
        run: |
          python3 << 'PYEOF'
          import json
          import re

          with open("mutations.json") as f:
              data = json.load(f)

          killed = sum(1 for f in data["files"] for m in f["mutations"] if m["status"] == "KILLED")
          lived = sum(1 for f in data["files"] for m in f["mutations"] if m["status"] == "LIVED")
          not_covered = sum(1 for f in data["files"] for m in f["mutations"] if m["status"] == "NOT COVERED")
          total = killed + lived + not_covered

          efficacy = (killed / (killed + lived) * 100) if (killed + lived) > 0 else 0.0
          coverage = ((killed + lived) / total * 100) if total > 0 else 0.0

          efficacy_status = "Pass" if efficacy >= 90 else "Fail"
          coverage_status = "Pass" if coverage >= 50 else "Fail"

          killed_pct = (killed / total * 100) if total > 0 else 0.0
          lived_pct = (lived / total * 100) if total > 0 else 0.0
          not_covered_pct = (not_covered / total * 100) if total > 0 else 0.0

          with open("README.md", "r") as f:
              readme = f.read()

          readme = re.sub(r"Mutations-\d+_total", f"Mutations-{total}_total", readme)

          new_section = f"""## Mutation Testing Report

          <table>
          <tr>
          <td>

          | Metric | Status | Value | Threshold |
          |:------:|:------:|:-----:|:---------:|
          | **Efficacy** | {efficacy_status} | **{efficacy:.1f}%** | >= 90% |
          | **Coverage** | {coverage_status} | **{coverage:.1f}%** | >= 50% |

          </td>
          <td>

          | Status | Count | Percentage |
          |:------:|:-----:|:----------:|
          | KILLED | {killed} | **{killed_pct:.1f}%** |
          | LIVED | {lived} | **{lived_pct:.1f}%** |
          | NOT COVERED | {not_covered} | **{not_covered_pct:.1f}%** |

          </td>
          </tr>
          </table>

          *Generated by Gremlins mutation testing tool*"""

          start = "<!-- MUTATION_TESTING_START -->"
          end = "<!-- MUTATION_TESTING_END -->"
          start_idx = readme.find(start)
          end_idx = readme.find(end)
          readme = readme[:start_idx + len(start)] + new_section + readme[end_idx:]

          with open("README.md", "w") as f:
              f.write(readme)
          PYEOF

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Update mutation testing stats
          file_pattern: README.md mutations.json
